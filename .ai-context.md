# AI Context - 暦 KOYOMI プロジェクト状態

**最終更新**: 2026年2月12日  
**フェーズ**: 実装期（60%） → 安定期への移行  
**Zone戦略**: 4層Zone + 監査モード

---

## 🏗️ Zone構造（4層）

### ❄️ Zone 0: 凍結コア
- `src/koyomi/layer1/engine.py`
- `src/koyomi/layer1/taizan_db.json`
- `src/koyomi/layer1/metaphor.py`
- **状態**: 凍結（監査モードのみ触れる）

### 🔴 Zone 1: 厳格制御
- `src/koyomi/chat/analyzer.py`
- `src/koyomi/chat/consultant.py`
- `tests/unit/test_layer1.py`
- **状態**: Plan必須、承認後実装

### 🟡 Zone 2A: 制御付き
- `src/koyomi/chat/hearing.py`
- `app.py`（ロジック部分）
- **状態**: 簡易Plan推奨

### 🟢 Zone 2B: 準自由
- `src/koyomi/chat/consultant.py`（プロンプト）
- `app.py`（UI文言）
- **状態**: 直接修正OK、事後報告

### 🟢 Zone 3: 自由
- `docs/`
- `static/css/`
- `README.md`
- **状態**: 即時実行OK

---

## 📊 現在の実装状況

### ✅ 完成（Zone 1: 厳格制御）

#### Layer1（四柱推命エンジン）
- `src/koyomi/layer1/engine.py` - 命式計算エンジン
- `src/koyomi/layer1/metaphor.py` - メタファー辞書120通り
- `src/koyomi/layer1/taizan_db.json` - 泰山流データ

**状態**: 安定・凍結  
**触るな**: 専門家の監修なしに修正禁止

---

### 🔧 実装中（Zone 2: 制御付き柔軟性）

#### 対話式コンサルタント
- `src/koyomi/chat/analyzer.py` - 統合分析エンジン
- `src/koyomi/chat/consultant.py` - Claude API統合
- `src/koyomi/chat/hearing.py` - ヒアリングエンジン
- `app.py` - Streamlit UI

**状態**: 基本機能完成、改善の余地あり  
**ルール**: /plan で計画提示 → 承認 → 実装

---

### ⬜ 未実装（Zone 2）

#### 相性分析の精度向上
- 五行の相生相克をより詳細に
- スコア計算ロジックの改善

#### チーム分析機能（3-10人）
- 複数人の相性を同時分析
- 役割分担の提案
- レーダーチャート可視化

---

### 📝 ドキュメント（Zone 3: 高速反復）

**状態**: 充実  
**ルール**: 直接修正OK（承認不要）

---

## 🎯 次のタスク

### 優先度1: 相性分析の精度向上

**目的**: 経営者が採用判断に使えるレベルに

**対象ファイル**:
- `src/koyomi/chat/analyzer.py`

**要件**:
- 相生相克の詳細判定
- 補完関係の明示
- 具体的な役割提案

**制約**:
- 既存の計算ロジック（Layer1）は変更しない
- テスト追加

---

### 優先度2: チーム分析機能

**目的**: 3-10人のチーム編成支援

**対象ファイル**:
- `src/koyomi/chat/analyzer.py`（追加）
- `app.py`（UI追加）

**要件**:
- 複数人の命式を同時計算
- チーム全体の五行バランス
- 不足要素の特定
- 最適な役割分担の提案

---

### 優先度3: 可視化

**目的**: 直感的な理解

**対象ファイル**:
- `app.py`（Plotly統合）

**要件**:
- 五行バランスのレーダーチャート
- 相性スコアの視覚化

---

## 📚 重要な決定事項

### 1. API Key設定

```python
# 環境変数で設定
ANTHROPIC_API_KEY="sk-ant-..."
```

**状態**: 任意（未設定でも基本機能は動作）  
**推奨**: 設定すると詳細なアドバイスが生成される

---

### 2. データ構造

#### BirthData
```python
@dataclass
class BirthData:
    datetime: datetime
    has_time: bool
    location: Optional[Tuple[float, float]]
```

#### PersonProfile
```python
@dataclass
class PersonProfile:
    name: str
    role: str
    birth_date: datetime
    birth_time: Optional[datetime]
```

---

### 3. 相性スコアの計算式

```python
# 基準点50
# 相生関係: +20-30
# 相克関係: -10-20
# 補完関係: +10-15
```

**状態**: 簡易版実装済み  
**改善**: より精緻な計算式が必要

---

## 🚨 重要な制約

### 絶対に守ること

1. **Layer1は触らない**
   - 命式計算エンジン
   - メタファー辞書
   - 泰山流データ

2. **テスト削除禁止**
   - エラーが出てもテストは消さない
   - コードを修正してテストを通す

3. **1ファイルずつ修正**
   - 複数ファイル同時修正禁止
   - 修正 → テスト → commit

---

## 💡 よくある質問

### Q: 相性分析の精度を上げたい

**A**: `src/koyomi/chat/analyzer.py` の `_calculate_compatibility_score()` を修正

**手順**:
1. /plan で計画提示
2. テストケース追加
3. ロジック改善
4. テスト実行
5. commit

---

### Q: UIを改善したい

**A**: `app.py` を修正（Zone 3なので承認不要）

**注意**:
- バックエンドロジックは触らない
- 見た目のみ修正

---

### Q: 新しいレイヤーを追加したい

**A**: 大きな変更なので要相談

**手順**:
1. PRD.md を更新
2. アーキテクチャ設計
3. テストコード作成
4. 実装

---

## 📊 技術的負債

### 現在の負債

1. **相性計算が簡易的**
   - より詳細な五行分析が必要

2. **テストカバレッジ不足**
   - chat/ モジュールのテストが未実装

3. **エラーハンドリングが弱い**
   - 例外処理の強化が必要

---

## 🎓 学習リソース

- [PRD.md](docs/PRD.md) - 要件定義
- [DEVELOPMENT_TDD.md](docs/DEVELOPMENT_TDD.md) - TDD手順
- [CONSULTANT_GUIDE.md](docs/CONSULTANT_GUIDE.md) - 使い方
- [CLAUDE_CODE_WORKFLOW.md](docs/CLAUDE_CODE_WORKFLOW.md) - 開発ワークフロー

---

**このファイルは開発の進捗に応じて随時更新してください**
